{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Military Examination Portal</title>
    <link href="{% static 'css/bootstrap/css/bootstrap.min.css' %}" rel="stylesheet">
    <script src="{% static 'css/bootstrap/js/bootstrap.bundle.min.js' %}"></script>
    <meta http-equiv="Cache-Control" content="no-store" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />

    <style>
        :root {
            --army-green: #2c4c2c;
            --army-dark-green: #1a2e1a;
            --army-gold: #c8b072;
            --army-tan: #d6c28e;
            --army-light: #3d6b3d;
            --text-light: #f0f0f0;
            --text-muted: #cccccc;
            --card-bg: rgba(34, 49, 34, 0.92);
            --sidebar-bg: rgba(26, 46, 26, 0.95);
            --success: #4caf50;
            --warning: #ff9800;
            --danger: #f44336;
            --current: #2196f3;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        /* Re-enable selection for input fields */
        input, textarea, [contenteditable="true"] {
            -webkit-user-select: text !important;
            -moz-user-select: text !important;
            -ms-user-select: text !important;
            user-select: text !important;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a2e1a url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2' fill='%233d6b3d' fill-opacity='0.1' fill-rule='evenodd'/%3E%3C/svg%3E");
            color: var(--text-light);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* Enhanced Fullscreen Controls Prevention */
        body:fullscreen,
        body:-webkit-full-screen,
        body:-moz-full-screen {
            overflow: hidden !important;
            position: fixed !important;
            width: 100% !important;
            height: 100% !important;
        }
        
        .exam-container {
            display: flex;
            flex: 1;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: var(--sidebar-bg);
            padding: 20px 15px;
            box-shadow: 3px 0 15px rgba(0, 0, 0, 0.4);
            display: flex;
            flex-direction: column;
            z-index: 10;
            border-right: 2px solid var(--army-gold);
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }
        
        .sidebar-header {
            text-align: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(200, 176, 114, 0.3);
        }
        
        .sidebar-header h2 {
            color: var(--army-gold);
            font-size: 1.4rem;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .time-remaining {
            background: rgba(0, 0, 0, 0.3);
            padding: 12px;
            border-radius: 6px;
            margin: 15px 0;
            text-align: center;
            border: 1px solid var(--army-gold);
        }
        
        .time-remaining span {
            font-weight: bold;
            color: var(--army-gold);
            font-size: 1.4rem;
            display: block;
            margin-top: 5px;
            letter-spacing: 1px;
        }
        
        .question-nav-container {
            flex: 1;
            overflow-y: auto;
            margin: 10px 0;
        }
        
        .question-nav {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
            margin-bottom: 20px;
        }
        
        .question-btn {
            width: 36px;
            height: 36px;
            font-size: 0.9rem;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.2);
            background: var(--army-dark-green);
            color: var(--text-light);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .question-btn:hover {
            transform: scale(1.1);
            border-color: var(--army-gold);
        }
        
        .question-btn.current {
            border: 2px solid var(--current);
            background: var(--current);
            color: white;
            box-shadow: 0 0 8px var(--current);
        }
        
        .question-btn.answered {
            background: var(--success);
            border-color: var(--success);
            color: white;
        }
        
        .question-btn.flagged {
            background: var(--danger);
            border-color: var(--danger);
            color: white;
        }
        
        .question-status {
            margin-top: 20px;
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 6px;
        }
        
        .status-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            font-size: 0.9rem;
        }
        
        .status-color {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            margin-right: 10px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .status-answered {
            background: var(--success);
        }
        
        .status-flagged {
            background: var(--danger);
        }
        
        .status-current {
            background: var(--current);
        }
        
        .status-not-answered {
            background: var(--army-dark-green);
        }

        /* Main Content */
        .main-content {
            margin-left: 280px;
            flex: 1;
            padding: 25px;
            overflow-y: auto;
            background: rgba(26, 46, 26, 0.7);
        }
        
        .exam-header {
            background: var(--card-bg);
            padding: 18px 25px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            margin-bottom: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid var(--army-gold);
        }
        
        .exam-title {
            color: var(--army-gold);
            margin: 0;
            font-weight: 600;
            font-size: 1.6rem;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }
        
        .question-card {
            background: var(--card-bg);
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            margin-bottom: 25px;
            border: 1px solid rgba(200, 176, 114, 0.2);
        }
        
        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .question-text {
            font-size: 1.2rem;
            color: var(--text-light);
            flex: 1;
            line-height: 1.5;
        }
        
        .marks-badge {
            font-size: 0.9rem;
            padding: 6px 12px;
            border-radius: 20px;
            background: var(--army-dark-green);
            color: var(--army-gold);
            white-space: nowrap;
            border: 1px solid var(--army-gold);
        }
        
        .options-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
            margin: 20px 0;
        }
        
        @media (min-width: 768px) {
            .options-container {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        .form-check {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            margin: 0;
            border-radius: 8px;
            border: 1px solid rgba(200, 176, 114, 0.2);
            background: rgba(26, 46, 26, 0.7);
            transition: all 0.2s ease;
        }
        
        .form-check:hover {
            background: rgba(40, 70, 40, 0.8);
            border-color: var(--army-gold);
        }
        
        .form-check-input {
            margin-right: 12px;
            cursor: pointer;
            width: 18px;
            height: 18px;
        }
        
        .form-check-label {
            width: 100%;
            cursor: pointer;
            font-size: 1.05rem;
            color: var(--text-light);
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border-radius: 8px;
            border: 1px solid rgba(200, 176, 114, 0.3);
            background: rgba(26, 46, 26, 0.7);
            color: var(--text-light);
            font-size: 1rem;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--army-gold);
            box-shadow: 0 0 0 2px rgba(200, 176, 114, 0.3);
        }
        
        textarea.form-control {
            min-height: 120px;
            resize: vertical;
            font-family: inherit;
        }
        
        .nav-controls {
            margin-top: 25px;
            display: flex;
            justify-content: space-between;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 20px;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            border: none;
            transition: all 0.2s ease;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-secondary {
            background: var(--army-dark-green);
            color: var(--army-gold);
            border: 1px solid var(--army-gold);
        }
        
        .btn-primary {
            background: var(--army-gold);
            color: var(--army-dark-green);
            border: 1px solid var(--army-gold);
        }
        
        .btn-warning {
            background: var(--danger);
            color: white;
            border: 1px solid var(--danger);
        }
        
        .btn-success {
            background: var(--success);
            color: white;
            border: 1px solid var(--success);
        }
        
        .question-page {
            display: none;
        }
        
        .question-page:first-child {
            display: block;
        }

        /* Confirmation Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 10000000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.9);
        }

        .modal-content {
            background: var(--card-bg);
            margin: 15% auto;
            padding: 30px;
            border: 2px solid var(--army-gold);
            border-radius: 10px;
            width: 80%;
            max-width: 500px;
            text-align: center;
            color: var(--text-light);
        }

        .modal h3 {
            color: var(--army-gold);
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        .modal p {
            margin-bottom: 25px;
            font-size: 1.1rem;
            line-height: 1.4;
        }

        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .modal-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .modal-btn-confirm {
            background: var(--success);
            color: white;
        }

        .modal-btn-cancel {
            background: var(--danger);
            color: white;
        }

        .modal-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        
        /* Responsive design */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .exam-container {
                flex-direction: column;
            }
            
            .options-container {
                grid-template-columns: 1fr !important;
            }
        }

        /* Prevent image dragging */
        img {
            -webkit-user-drag: none;
            -khtml-user-drag: none;
            -moz-user-drag: none;
            -o-user-drag: none;
            user-drag: none;
            pointer-events: none;
        }
        
        /* Hide scrollbars to prevent right-click on them */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--army-dark-green);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--army-gold);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--army-tan);
        }
        
        /* Ensure interactive elements remain clickable */
        button, input, textarea, .form-check-input, .form-check-label, .question-btn {
            pointer-events: auto !important;
            cursor: pointer !important;
        }
        
        input, textarea {
            cursor: text !important;
        }

    </style>
</head>

<body>

     <div id="fullscreenOverlay" style="
        position:fixed;top:0;left:0;width:100%;height:100%;
        background:#000;color:#fff;z-index:9999;
        display:flex;align-items:center;justify-content:center;
        flex-direction:column;text-align:center;">
        <h2 style="margin-bottom:20px;">Your exam will start in Fullscreen Mode</h2>
        <button id="enterFullscreenBtn" style="
            font-size:20px;padding:15px 25px;
            background:#c8b072;color:#000;
            border:none;border-radius:8px;cursor:pointer;">
            üöÄ Start Exam
        </button>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmationModal" class="modal">
        <div class="modal-content">
            <h3>‚ö†Ô∏è Submit Exam Confirmation</h3>
            <p>Are you sure you want to submit your exam?<br>
            Once submitted, you cannot make any changes.</p>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-confirm" id="confirmSubmit">
                    ‚úì Yes, Submit Exam
                </button>
                <button class="modal-btn modal-btn-cancel" id="cancelSubmit">
                    ‚úó Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Security Warning Modal - PROFESSIONAL MILITARY THEME WITH MOUSE LOCK -->
    <div id="securityWarningModal" class="modal" style="z-index: 99999999;">
        <div class="modal-content" style="
            background: linear-gradient(135deg, #1a2e1a 0%, #2c4c2c 50%, #1a2e1a 100%);
            border: 4px solid #c8b072;
            box-shadow: 
                0 0 40px rgba(200, 176, 114, 0.6),
                inset 0 0 20px rgba(200, 176, 114, 0.1);
            max-width: 700px;
            padding: 50px;
            position: relative;
            overflow: hidden;">
            
            <!-- Military Header Stripe -->
            <div style="
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                height: 8px;
                background: linear-gradient(90deg, #c8b072 0%, #d6c28e 50%, #c8b072 100%);
            "></div>
            
            <!-- Military Badge/Emblem -->
            <div style="
                text-align: center;
                margin-bottom: 35px;
                position: relative;">
                <div style="
                    width: 100px;
                    height: 100px;
                    margin: 0 auto 25px;
                    background: radial-gradient(circle, #2c4c2c 0%, #1a2e1a 70%);
                    border: 4px solid #c8b072;
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    position: relative;
                    box-shadow: 
                        0 0 20px rgba(200, 176, 114, 0.4),
                        inset 0 0 10px rgba(0, 0, 0, 0.5);">
                    
                    <!-- Military Star -->
                    <div style="
                        width: 50px;
                        height: 50px;
                        background: #c8b072;
                        clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);
                        filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));
                    "></div>
                </div>
                
                <h3 style="
                    color: #c8b072;
                    font-size: 1.6rem;
                    margin: 0;
                    text-transform: uppercase;
                    letter-spacing: 3px;
                    font-weight: 700;
                    text-shadow: 2px 2px 4px rgba(0,0,0,0.7);
                    font-family: 'Arial Black', Arial, sans-serif;">
                    SECURITY PROTOCOL VIOLATION
                </h3>
                
                <div style="
                    width: 200px;
                    height: 2px;
                    background: linear-gradient(90deg, transparent 0%, #c8b072 50%, transparent 100%);
                    margin: 15px auto;
                "></div>
            </div>
            
            <!-- Violation Details -->
            <div style="
                background: rgba(0, 0, 0, 0.4);
                border: 2px solid #c8b072;
                border-left: 6px solid #c8b072;
                padding: 25px;
                margin-bottom: 30px;
                position: relative;">
                
                <div style="
                    position: absolute;
                    top: -2px;
                    right: -2px;
                    background: #c8b072;
                    color: #1a2e1a;
                    padding: 5px 15px;
                    font-size: 0.8rem;
                    font-weight: bold;
                    text-transform: uppercase;
                    letter-spacing: 1px;">
                    CLASSIFIED
                </div>
                
                <h4 style="
                    color: #c8b072;
                    font-size: 1.1rem;
                    margin: 0 0 15px 0;
                    text-transform: uppercase;
                    letter-spacing: 1px;
                    font-weight: 600;">
                    VIOLATION REPORT
                </h4>
                
                <p style="
                    color: #f0f0f0;
                    font-size: 1.1rem;
                    font-weight: 500;
                    margin: 0 0 20px 0;
                    line-height: 1.6;" id="violationMessage">
                    Unauthorized attempt to exit secure examination environment detected.
                </p>
                
                <div style="
                    background: rgba(200, 176, 114, 0.1);
                    border: 1px solid #c8b072;
                    padding: 15px;
                    margin-top: 15px;">
                    <p style="
                        color: #d6c28e;
                        font-size: 0.95rem;
                        margin: 0;
                        text-align: center;
                        font-weight: 500;">
                        EXAMINATION PROGRESS HAS BEEN AUTOMATICALLY SECURED
                    </p>
                </div>
            </div>
            
            <!-- Action Required Section -->
            <div style="
                background: linear-gradient(135deg, rgba(200, 176, 114, 0.1) 0%, rgba(200, 176, 114, 0.05) 100%);
                border: 2px solid #c8b072;
                padding: 25px;
                margin-bottom: 35px;
                text-align: center;">
                
                <h4 style="
                    color: #c8b072;
                    font-size: 1.2rem;
                    margin: 0 0 20px 0;
                    text-transform: uppercase;
                    letter-spacing: 2px;
                    font-weight: 700;">
                    ACTION REQUIRED
                </h4>
                
                <p style="
                    color: #f0f0f0;
                    font-size: 1rem;
                    margin: 0;
                    line-height: 1.5;">
                    Select your course of action to proceed with the examination protocol.
                </p>
            </div>
            
            <!-- Command Buttons -->
            <div class="modal-buttons" style="
                display: flex;
                gap: 20px;
                justify-content: center;
                margin-bottom: 25px;">
                
                <button class="modal-btn" id="backToExam" style="
                    background: linear-gradient(135deg, #2c4c2c 0%, #3d6b3d 100%);
                    color: #c8b072;
                    font-size: 1rem;
                    padding: 18px 35px;
                    border: 3px solid #c8b072;
                    cursor: pointer;
                    font-weight: 700;
                    text-transform: uppercase;
                    letter-spacing: 1px;
                    box-shadow: 
                        0 4px 15px rgba(200, 176, 114, 0.3),
                        inset 0 1px 0 rgba(255, 255, 255, 0.1);
                    transition: all 0.3s ease;
                    position: relative;
                    overflow: hidden;">
                    
                    <span style="position: relative; z-index: 2;">
                        RETURN TO EXAMINATION
                    </span>
                    
                    <div style="
                        position: absolute;
                        top: 0;
                        left: -100%;
                        width: 100%;
                        height: 100%;
                        background: linear-gradient(90deg, transparent, rgba(200, 176, 114, 0.2), transparent);
                        transition: left 0.5s ease;
                    " class="button-shine"></div>
                </button>
                
                <button class="modal-btn" id="exitExam" style="
                    background: linear-gradient(135deg, #4a1a1a 0%, #6d2c2c 100%);
                    color: #c8b072;
                    font-size: 1rem;
                    padding: 18px 35px;
                    border: 3px solid #c8b072;
                    cursor: pointer;
                    font-weight: 700;
                    text-transform: uppercase;
                    letter-spacing: 1px;
                    box-shadow: 
                        0 4px 15px rgba(200, 176, 114, 0.3),
                        inset 0 1px 0 rgba(255, 255, 255, 0.1);
                    transition: all 0.3s ease;
                    position: relative;
                    overflow: hidden;">
                    
                    <span style="position: relative; z-index: 2;">
                        SUBMIT EXAM
                    </span>
                    
                    <div style="
                        position: absolute;
                        top: 0;
                        left: -100%;
                        width: 100%;
                        height: 100%;
                        background: linear-gradient(90deg, transparent, rgba(200, 176, 114, 0.2), transparent);
                        transition: left 0.5s ease;
                    " class="button-shine"></div>
                </button>
            </div>
            
            <!-- Footer Classification -->
            <div style="
                text-align: center;
                padding-top: 20px;
                border-top: 2px solid rgba(200, 176, 114, 0.3);">
                <p style="
                    color: #d6c28e;
                    font-size: 0.85rem;
                    margin: 0;
                    text-transform: uppercase;
                    letter-spacing: 1px;
                    opacity: 0.8;">
                    MILITARY EXAMINATION SECURITY PROTOCOL
                </p>
            </div>
            
            <!-- Military Corner Decorations -->
            <div style="
                position: absolute;
                top: 15px;
                left: 15px;
                width: 30px;
                height: 30px;
                border-top: 3px solid #c8b072;
                border-left: 3px solid #c8b072;
            "></div>
            <div style="
                position: absolute;
                top: 15px;
                right: 15px;
                width: 30px;
                height: 30px;
                border-top: 3px solid #c8b072;
                border-right: 3px solid #c8b072;
            "></div>
            <div style="
                position: absolute;
                bottom: 15px;
                left: 15px;
                width: 30px;
                height: 30px;
                border-bottom: 3px solid #c8b072;
                border-left: 3px solid #c8b072;
            "></div>
            <div style="
                position: absolute;
                bottom: 15px;
                right: 15px;
                width: 30px;
                height: 30px;
                border-bottom: 3px solid #c8b072;
                border-right: 3px solid #c8b072;
            "></div>
        </div>
    </div>

    <style>
        /* Professional Military Modal with Mouse Lock */
        #securityWarningModal {
            backdrop-filter: blur(10px);
            background: rgba(0, 0, 0, 0.95) !important;
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            pointer-events: auto !important;
        }
        
        #securityWarningModal .modal-content {
            animation: militaryModalEntry 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        
        @keyframes militaryModalEntry {
            0% { 
                transform: scale(0.8) translateY(-50px);
                opacity: 0;
            }
            100% { 
                transform: scale(1) translateY(0);
                opacity: 1;
            }
        }
        
        /* Button Hover Effects */
        #backToExam:hover, #exitExam:hover {
            transform: translateY(-3px);
            box-shadow: 
                0 8px 25px rgba(200, 176, 114, 0.5),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }
        
        #backToExam:hover .button-shine,
        #exitExam:hover .button-shine {
            left: 100%;
        }
        
        #backToExam:active, #exitExam:active {
            transform: translateY(-1px);
        }
        
        /* MOUSE LOCK SYSTEM - Prevents all interactions outside modal */
        body.modal-open {
            overflow: hidden !important;
            pointer-events: none !important;
        }
        
        body.modal-open #securityWarningModal,
        body.modal-open #securityWarningModal * {
            pointer-events: auto !important;
        }
        
        /* Block all other page elements */
        body.modal-open #examContent,
        body.modal-open #fullscreenOverlay,
        body.modal-open #confirmationModal {
            pointer-events: none !important;
        }
        
        /* Ensure modal is always on top and captures all events */
        #securityWarningModal::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: transparent;
            z-index: -1;
            pointer-events: auto;
        }
    </style>

<div id="examContent" style="display:none;">
    <div class="exam-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>Question Navigator</h2>
                <div class="time-remaining">
                    <i class="far fa-clock"></i> Time Left: <span id="timer">03:00:00</span>
                </div>
            </div>

            <div class="question-nav-container">
                <div class="question-nav">
                    {% for question in questions %}
                    <button type="button"
                            class="question-btn {% if forloop.first %}current{% endif %}"
                            id="nav-btn-{{ question.question.id }}"
                            onclick="showQuestion({{ forloop.counter0 }})">
                        {{ forloop.counter }}
                    </button>
                    {% endfor %}
                </div>
            </div>

            <div class="question-status">
                <div class="status-item"><div class="status-color status-current"></div> Current Question</div>
                <div class="status-item"><div class="status-color status-answered"></div> Answered</div>
                <div class="status-item"><div class="status-color status-flagged"></div> Flagged</div>
                <div class="status-item"><div class="status-color status-not-answered"></div> Not Answered</div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="exam-header">
                <h1 class="exam-title">{{ paper.question_paper }}{% if paper.trade %} ‚Äî {{ paper.trade }}{% endif %}</h1>
            </div>

            <form method="post" id="exam-form" action="{% url 'exam_interface' %}">
                {% csrf_token %}
                <input type="hidden" name="session_id" value="{{ session.id }}">
                <input type="hidden" name="paper_id" value="{{ paper.id }}">

                {% for question in questions %}
                <div class="question-card question-page" id="question-{{ forloop.counter0 }}" style="{% if not forloop.first %}display:none{% endif %}">
                    <div class="question-header">
                        <h2 class="question-text">Q{{ forloop.counter }}. {{ question.question.text }}</h2>
                        <span class="marks-badge">{{ question.question.marks }} Marks</span>
                    </div>

                    <div class="options-container">
                        {# MCQ parts A/B: Always show 4 multiple choice options #}
                        {% if question.question.part in "AB" %}
                            {# Use new separate option fields first, fallback to old options JSON #}
                            {% if question.question.option_a %}
                                {# Use new separate option fields #}
                                <div class="form-check">
                                    <input class="form-check-input" type="radio"
                                           name="question_{{ question.question.id }}"
                                           id="q{{ question.question.id }}_opt1"
                                           value="{{ question.question.option_a }}"
                                           onchange="markAnswered({{ question.question.id }})">
                                    <label class="form-check-label" for="q{{ question.question.id }}_opt1">{{ question.question.option_a }}</label>
                                </div>
                                {% if question.question.option_b %}
                                <div class="form-check">
                                    <input class="form-check-input" type="radio"
                                           name="question_{{ question.question.id }}"
                                           id="q{{ question.question.id }}_opt2"
                                           value="{{ question.question.option_b }}"
                                           onchange="markAnswered({{ question.question.id }})">
                                    <label class="form-check-label" for="q{{ question.question.id }}_opt2">{{ question.question.option_b }}</label>
                                </div>
                                {% endif %}
                                {% if question.question.option_c %}
                                <div class="form-check">
                                    <input class="form-check-input" type="radio"
                                           name="question_{{ question.question.id }}"
                                           id="q{{ question.question.id }}_opt3"
                                           value="{{ question.question.option_c }}"
                                           onchange="markAnswered({{ question.question.id }})">
                                    <label class="form-check-label" for="q{{ question.question.id }}_opt3">{{ question.question.option_c }}</label>
                                </div>
                                {% endif %}
                                {% if question.question.option_d %}
                                <div class="form-check">
                                    <input class="form-check-input" type="radio"
                                           name="question_{{ question.question.id }}"
                                           id="q{{ question.question.id }}_opt4"
                                           value="{{ question.question.option_d }}"
                                           onchange="markAnswered({{ question.question.id }})">
                                    <label class="form-check-label" for="q{{ question.question.id }}_opt4">{{ question.question.option_d }}</label>
                                </div>
                                {% endif %}
                            {% elif question.question.options and question.question.options.choices %}
                                {# Fallback: Use old JSON options format #}
                                {% for choice in question.question.options.choices %}
                                    {% if choice %}
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio"
                                               name="question_{{ question.question.id }}"
                                               id="q{{ question.question.id }}_opt{{ forloop.counter }}"
                                               value="{{ choice }}"
                                               onchange="markAnswered({{ question.question.id }})">
                                        <label class="form-check-label" for="q{{ question.question.id }}_opt{{ forloop.counter }}">{{ choice }}</label>
                                    </div>
                                    {% endif %}
                                {% endfor %}
                            {% elif question.question.options %}
                                {# Fallback: Options might be a list/array directly #}
                                {% for choice in question.question.options %}
                                    {% if choice %}
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio"
                                               name="question_{{ question.question.id }}"
                                               id="q{{ question.question.id }}_opt{{ forloop.counter }}"
                                               value="{{ choice }}"
                                               onchange="markAnswered({{ question.question.id }})">
                                        <label class="form-check-label" for="q{{ question.question.id }}_opt{{ forloop.counter }}">{{ choice }}</label>
                                    </div>
                                    {% endif %}
                                {% endfor %}
                            {% else %}
                                {# No options available - provide standard A, B, C, D options #}
                                {% for choice in "ABCD" %}
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio"
                                               name="question_{{ question.question.id }}"
                                               id="q{{ question.question.id }}_opt{{ forloop.counter }}"
                                               value="Option {{ choice }}"
                                               onchange="markAnswered({{ question.question.id }})">
                                        <label class="form-check-label" for="q{{ question.question.id }}_opt{{ forloop.counter }}">Option {{ choice }}</label>
                                    </div>
                                {% endfor %}
                            {% endif %}
                        
                        {% elif question.question.part == "C" %}
                            {# Short answer text area #}
                            <textarea name="question_{{ question.question.id }}" 
                                      rows="3" 
                                      class="form-control long-answer-input"
                                      data-question-index="{{ forloop.counter0 }}"
                                      placeholder="Type your detailed answer (30-50 words)" 
                                      onchange="markAnswered({{ question.question.id }})"></textarea>
                        {% elif question.question.part == "D" %}
                            {# Fill in the blanks - must be textbox (Part D) #}
                            <input type="text" 
                                   name="question_{{ question.question.id }}" 
                                   class="form-control fill-blank-input"
                                   data-question-index="{{ forloop.counter0 }}"
                                   placeholder="Enter your answer" 
                                   onchange="markAnswered({{ question.question.id }})">
                        {% elif question.question.part == "E" %}
                            {# Long answer text area #}
                            <textarea name="question_{{ question.question.id }}" 
                                      rows="4" 
                                      class="form-control long-answer-input"
                                      data-question-index="{{ forloop.counter0 }}"
                                      placeholder="Type your detailed answer (100-120 words)" 
                                      onchange="markAnswered({{ question.question.id }})"></textarea>
                        {% elif question.question.part == "F" %}
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="question_{{ question.question.id }}" id="q{{ question.question.id }}_true" value="True." onchange="markAnswered({{ question.question.id }})">
                                <label class="form-check-label" for="q{{ question.question.id }}_true">True</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="question_{{ question.question.id }}" id="q{{ question.question.id }}_false" value="False." onchange="markAnswered({{ question.question.id }})">
                                <label class="form-check-label" for="q{{ question.question.id }}_false">False</label>
                            </div>
                        {% else %}
                            {# Catch-all fallback #}
                            <input type="text" name="question_{{ question.question.id }}" class="form-control" onchange="markAnswered({{ question.question.id }})">
                        {% endif %}
                    </div>

                    <div class="nav-controls">
                        {% if not forloop.first %}
                        <button type="button" class="btn btn-secondary" onclick="prevQuestion({{ forloop.counter0 }})">
                            <i class="fas fa-arrow-left"></i> Previous
                        </button>
                        {% endif %}
                        <button type="button" class="btn btn-warning" onclick="flagQuestion({{ question.question.id }})">
                            <i class="fas fa-flag"></i> Flag
                        </button>
                        {% if not forloop.last %}
                        <button type="button" class="btn btn-primary" onclick="nextQuestion({{ forloop.counter0 }})">
                            Next <i class="fas fa-arrow-right"></i>
                        </button>
                        {% else %}
                        <button type="button" class="btn btn-success" id="final-submit">
                            <i class="fas fa-paper-plane"></i> Submit Exam
                        </button>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  let examSubmitted = false;
  let isExamTerminated = false;
  let examStarted = false;
  let violationCount = 0;
  let isShowingWarning = false;
  let maxViolations = Infinity; // INFINITE WARNINGS - NO TERMINATION LIMIT
  let fullscreenCheckInterval = null;
  // Removed pointer lock to fix mouse cursor disappearing issue
  
  // ---------------------------
  // NUCLEAR OPTION: ABSOLUTE FULLSCREEN LOCK
  // ---------------------------
  
  function isInFullscreen() {
    return !!(document.fullscreenElement || document.webkitFullscreenElement || 
             document.mozFullScreenElement || document.msFullscreenElement);
  }
  
  function showSecurityWarning(reason) {
    if (isShowingWarning || examSubmitted || isExamTerminated) return;
    
    isShowingWarning = true;
    violationCount++;
    
    // Save progress immediately
    saveCurrentProgress();
    
    // Log the violation
    logSecurityViolation(`WARNING ${violationCount}: ${reason}`);
    
    // Update violation message with professional military language
    const violationMsg = document.getElementById('violationMessage');
    violationMsg.innerHTML = `
      <strong>VIOLATION #${violationCount}:</strong><br>
      ${reason}<br><br>
      <span style="color: #d6c28e;">
        This incident has been logged in the security database.
      </span>
    `;
    
    // ENABLE MOUSE LOCK - Block all interactions outside modal
    document.body.classList.add('modal-open');
    
    // Show warning modal (STAYS IN FULLSCREEN)
    document.getElementById('securityWarningModal').style.display = 'block';
    
    // Force focus on modal and trap it
    document.getElementById('backToExam').focus();
    
    // Prevent tabbing out of modal
    trapFocusInModal();
  }
  
  function hideSecurityWarning() {
    isShowingWarning = false;
    
    // DISABLE MOUSE LOCK - Restore normal interactions
    document.body.classList.remove('modal-open');
    
    document.getElementById('securityWarningModal').style.display = 'none';
  }
  
  // Focus trap function to keep focus within modal
  function trapFocusInModal() {
    const modal = document.getElementById('securityWarningModal');
    const focusableElements = modal.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
    const firstElement = focusableElements[0];
    const lastElement = focusableElements[focusableElements.length - 1];
    
    modal.addEventListener('keydown', (e) => {
      if (e.key === 'Tab') {
        if (e.shiftKey) {
          if (document.activeElement === firstElement) {
            e.preventDefault();
            lastElement.focus();
          }
        } else {
          if (document.activeElement === lastElement) {
            e.preventDefault();
            firstElement.focus();
          }
        }
      }
    });
  }
  
  function terminateExamImmediately(reason) {
    if (isExamTerminated || examSubmitted) return;
    
    isExamTerminated = true;
    examSubmitted = true;
    
    // Stop fullscreen monitoring
    if (fullscreenCheckInterval) {
      clearInterval(fullscreenCheckInterval);
    }
    
    // Save current progress immediately
    saveCurrentProgress();
    
    // Log the termination
    logSecurityViolation(`EXAM TERMINATED: ${reason}`);
    
    // Hide any warnings
    hideSecurityWarning();
    
    // Show termination message
    alert(`EXAM TERMINATED!\n\nReason: ${reason}\n\nYour progress has been saved and the exam is now ended.`);
    
    // Submit the form immediately
    const form = document.getElementById("exam-form");
    if (form) {
      const hiddenInput = document.createElement('input');
      hiddenInput.type = 'hidden';
      hiddenInput.name = 'exam_terminated';
      hiddenInput.value = 'true';
      form.appendChild(hiddenInput);
      
      const reasonInput = document.createElement('input');
      reasonInput.type = 'hidden';
      reasonInput.name = 'termination_reason';
      reasonInput.value = reason;
      form.appendChild(reasonInput);
      
      // Exit fullscreen before submitting
      exitFullScreen().finally(() => {
        form.submit();
      });
    } else {
      // Fallback: redirect to logout
      exitFullScreen().finally(() => {
        window.location.href = '/candidate/login/';
      });
    }
  }

  function logSecurityViolation(reason) {
    const timestamp = new Date().toISOString();
    console.warn(`[${timestamp}] SECURITY VIOLATION: ${reason}`);
    
    const violations = JSON.parse(localStorage.getItem('examSecurityViolations') || '[]');
    violations.push({
      timestamp,
      reason,
      userAgent: navigator.userAgent,
      url: window.location.href
    });
    localStorage.setItem('examSecurityViolations', JSON.stringify(violations));
  }

  function saveCurrentProgress() {
    const formData = new FormData(document.getElementById("exam-form"));
    const answers = {};
    
    for (let [key, value] of formData.entries()) {
      if (key.startsWith('question_')) {
        answers[key] = value;
      }
    }
    
    localStorage.setItem('examProgress', JSON.stringify({
      timestamp: new Date().toISOString(),
      answers: answers,
      reason: 'Security violation backup',
      violationCount: violationCount
    }));
    
    console.log('Progress saved:', Object.keys(answers).length, 'answers');
  }

  // ---------------------------
  // NUCLEAR FULLSCREEN CONTROL
  // ---------------------------
  function enterFullScreen() {
    const el = document.documentElement;
    const fn = el.requestFullscreen || el.mozRequestFullScreen || el.webkitRequestFullscreen || el.msRequestFullscreen;

    if (!fn) return Promise.reject(new Error("Fullscreen API not supported"));
    try {
      const maybe = fn.call(el);
      return (maybe && typeof maybe.then === "function") ? maybe : Promise.resolve();
    } catch (e) {
      return Promise.reject(e);
    }
  }

  function exitFullScreen() {
    const fn = document.exitFullscreen || document.webkitExitFullscreen || document.mozCancelFullScreen || document.msExitFullscreen;

    if (!fn) return Promise.resolve();
    try {
      const maybe = fn.call(document);
      return (maybe && typeof maybe.then === "function") ? maybe : Promise.resolve();
    } catch {
      return Promise.resolve();
    }
  }

  // NUCLEAR OPTION: Aggressive fullscreen enforcement
  function enforceFullscreen() {
    if (examSubmitted || isExamTerminated) return;
    
    if (!isInFullscreen() && examStarted) {
      // Immediately try to re-enter fullscreen
      enterFullScreen().catch(() => {
        // If we can't re-enter fullscreen, show warning
        if (!isShowingWarning) {
          if (violationCount >= maxViolations) {
            terminateExamImmediately("Maximum violations reached - Cannot maintain fullscreen");
          } else {
            showSecurityWarning("Exited fullscreen mode - Please stay in fullscreen during exam");
          }
        }
      });
    }
  }

  // Removed pointer lock functions to fix mouse cursor disappearing issue
  // Mouse cursor will remain visible and functional during exam

  // ---------------------------
  // Start Exam button
  // ---------------------------
  const startBtn = document.getElementById("enterFullscreenBtn");
  if (startBtn) {
    console.log("Start button found, adding event listener");
    startBtn.addEventListener("click", () => {
      console.log("Start button clicked, attempting to enter fullscreen");
      enterFullScreen()
        .then(() => {
          console.log("Fullscreen entered successfully, showing exam content");
          document.getElementById("fullscreenOverlay").style.display = "none";
          document.getElementById("examContent").style.display = "block";
          examStarted = true;
          
          // Start NUCLEAR fullscreen monitoring (every 10ms)
          fullscreenCheckInterval = setInterval(enforceFullscreen, 10);
          
          // Mouse cursor will remain visible and functional
          
          console.log("üîí NUCLEAR FULLSCREEN LOCK ACTIVATED - Monitoring every 10ms");
        })
        .catch(err => {
          console.error("Fullscreen failed:", err);
          alert("Fullscreen is required to start the exam. Please allow fullscreen and try again.");
        });
    });
  } else {
    console.error("Start button not found!");
  }

  // ---------------------------
  // NUCLEAR SECURITY WARNING SYSTEM
  // ---------------------------
  
  // Security Warning Modal Event Handlers
  document.getElementById('backToExam').addEventListener('click', () => {
    hideSecurityWarning();
    
    // IMMEDIATELY force back to fullscreen
    enterFullScreen().then(() => {
      // Mouse cursor remains visible and functional
    }).catch(() => {
      // If fullscreen fails, terminate exam
      terminateExamImmediately("Failed to return to fullscreen mode after warning");
    });
  });

  document.getElementById('exitExam').addEventListener('click', () => {
    hideSecurityWarning();
    examSubmitted = true;
    
    // Stop fullscreen monitoring
    if (fullscreenCheckInterval) {
      clearInterval(fullscreenCheckInterval);
    }
    
    // Mouse cursor remains visible and functional
    
    // Save final progress
    saveCurrentProgress();
    
    // Exit fullscreen and submit
    exitFullScreen().finally(() => {
      const form = document.getElementById("exam-form");
      if (form) {
        const hiddenInput = document.createElement('input');
        hiddenInput.type = 'hidden';
        hiddenInput.name = 'voluntary_exit';
        hiddenInput.value = 'true';
        form.appendChild(hiddenInput);
        
        form.submit();
      } else {
        window.location.href = '/candidate/login/';
      }
    });
  });

  // ---------------------------
  // NUCLEAR FULLSCREEN CHANGE DETECTION
  // ---------------------------
  
  // Multiple redundant fullscreen change listeners
  function onFullscreenChange() {
    if (!examStarted || examSubmitted || isExamTerminated) return;
    
    if (!isInFullscreen()) {
      // IMMEDIATELY try to re-enter fullscreen (no delays)
      enterFullScreen().catch(() => {
        // If immediate re-entry fails, show warning
        if (!isShowingWarning) {
          if (violationCount >= maxViolations) {
            terminateExamImmediately("Maximum violations reached - Cannot maintain fullscreen");
          } else {
            showSecurityWarning("Fullscreen mode was exited - Please stay in fullscreen during exam");
          }
        }
      });
    }
  }
  
  // Attach to all possible fullscreen change events
  document.addEventListener("fullscreenchange", onFullscreenChange, true);
  document.addEventListener("webkitfullscreenchange", onFullscreenChange, true);
  document.addEventListener("mozfullscreenchange", onFullscreenChange, true);
  document.addEventListener("MSFullscreenChange", onFullscreenChange, true);

  // Additional redundant monitoring
  document.addEventListener("fullscreenerror", () => {
    if (examStarted && !examSubmitted && !isExamTerminated) {
      logSecurityViolation("Fullscreen error detected");
    }
  });

  // ---------------------------
  // NUCLEAR KEYBOARD BLOCKING
  // ---------------------------
  
  // Block at capture phase (earliest possible)
  document.addEventListener('keydown', (e) => {
    if (!examStarted || isShowingWarning) return;
    
    // COMPLETELY BLOCK Escape key - INFINITE WARNINGS
    if (e.key === 'Escape' || e.keyCode === 27 || e.which === 27) {
      e.preventDefault();
      e.stopImmediatePropagation();
      e.stopPropagation();
      
      // INFINITE WARNINGS - NO TERMINATION
      showSecurityWarning("Escape key is not allowed during examination");
      return false;
    }

    // COMPLETELY BLOCK F11 - INFINITE WARNINGS
    if (e.key === 'F11' || e.keyCode === 122 || e.which === 122) {
      e.preventDefault();
      e.stopImmediatePropagation();
      e.stopPropagation();
      
      // INFINITE WARNINGS - NO TERMINATION
      showSecurityWarning("F11 key is not allowed during examination");
      return false;
    }

    // Block Alt+Tab - INFINITE WARNINGS
    if ((e.altKey && e.key === 'Tab') || (e.metaKey && e.key === 'Tab')) {
      e.preventDefault();
      e.stopImmediatePropagation();
      e.stopPropagation();
      
      // INFINITE WARNINGS - NO TERMINATION
      showSecurityWarning("Alt+Tab is not allowed during examination - Do not switch applications");
      return false;
    }

    // Block all function keys - INFINITE WARNINGS
    const functionKeys = ["F1", "F2", "F3", "F4", "F5", "F6", "F7", "F8", "F9", "F10", "F12"];
    if (functionKeys.includes(e.key)) {
      e.preventDefault();
      e.stopImmediatePropagation();
      e.stopPropagation();
      
      // INFINITE WARNINGS - NO TERMINATION
      showSecurityWarning(`${e.key} key is not allowed during examination`);
      return false;
    }

    // Block dangerous combinations - INFINITE WARNINGS
    const dangerousCombos = [
      { ctrl: true, shift: true, key: "I", desc: "Developer Tools access" },
      { ctrl: true, shift: true, key: "J", desc: "Console access" },
      { ctrl: true, shift: true, key: "C", desc: "Inspector access" },
      { ctrl: true, key: "W", desc: "Close Tab attempt" },
      { ctrl: true, key: "T", desc: "New Tab attempt" },
      { ctrl: true, key: "N", desc: "New Window attempt" },
      { ctrl: true, key: "R", desc: "Page Refresh attempt" },
      { alt: true, key: "F4", desc: "Close Window attempt" },
      { meta: true, key: "q", desc: "Quit Application attempt" },
    ];

    for (const combo of dangerousCombos) {
      let matches = true;
      if (combo.ctrl && !e.ctrlKey) matches = false;
      if (combo.shift && !e.shiftKey) matches = false;
      if (combo.alt && !e.altKey) matches = false;
      if (combo.meta && !e.metaKey) matches = false;
      if (combo.key && e.key !== combo.key) matches = false;

      if (matches) {
        e.preventDefault();
        e.stopImmediatePropagation();
        e.stopPropagation();
        
        // INFINITE WARNINGS - NO TERMINATION
        showSecurityWarning(`${combo.desc} is not allowed during examination`);
        return false;
      }
    }
  }, true); // Capture phase

  // Additional keyup blocking for Escape
  document.addEventListener('keyup', (e) => {
    if (examStarted && !isShowingWarning) {
      if (e.key === 'Escape' || e.keyCode === 27 || e.which === 27) {
        e.preventDefault();
        e.stopImmediatePropagation();
        e.stopPropagation();
        return false;
      }
      if (e.key === 'F11' || e.keyCode === 122 || e.which === 122) {
        e.preventDefault();
        e.stopImmediatePropagation();
        e.stopPropagation();
        return false;
      }
    }
  }, true);

  // Additional keypress blocking for Escape
  document.addEventListener('keypress', (e) => {
    if (examStarted && !isShowingWarning) {
      if (e.key === 'Escape' || e.keyCode === 27 || e.which === 27) {
        e.preventDefault();
        e.stopImmediatePropagation();
        e.stopPropagation();
        return false;
      }
      if (e.key === 'F11' || e.keyCode === 122 || e.which === 122) {
        e.preventDefault();
        e.stopImmediatePropagation();
        e.stopPropagation();
        return false;
      }
    }
  }, true);

  // ---------------------------
  // WINDOW FOCUS MONITORING WITH WARNINGS
  // ---------------------------
  window.addEventListener('blur', () => {
    if (examStarted && !examSubmitted && !isExamTerminated && !isShowingWarning) {
      setTimeout(() => {
        if (!document.hasFocus() && !examSubmitted && !isExamTerminated && !isShowingWarning) {
          if (violationCount >= maxViolations) {
            terminateExamImmediately("Maximum security violations reached - Window focus lost");
          } else {
            showSecurityWarning("Do not click outside the exam window or switch to other applications");
          }
        }
      }, 1000); // 1 second delay to avoid false positives
    }
  });

  // Tab visibility monitoring - IMMEDIATE TERMINATION (NO WARNINGS)
  document.addEventListener('visibilitychange', () => {
    if (examStarted && document.hidden && !examSubmitted && !isExamTerminated && !isShowingWarning) {
      // IMMEDIATE TERMINATION on tab switch - NO SECOND CHANCES
      terminateExamImmediately("Tab was switched or window was minimized - Exam terminated for security");
    }
  });

  // ---------------------------
  // MOUSE CONTROLS WITH WARNINGS
  // ---------------------------
  
  // Right-click warning - INFINITE WARNINGS
  document.addEventListener("contextmenu", e => {
    if (!examStarted || isShowingWarning) return;
    
    e.preventDefault();
    e.stopImmediatePropagation();
    
    // INFINITE WARNINGS - NO TERMINATION
    showSecurityWarning("Right-click is not allowed during examination");
    return false;
  }, true);

  // Mouse button warnings - INFINITE WARNINGS
  document.addEventListener("mousedown", e => {
    if (!examStarted || isShowingWarning) return;
    
    if (e.button === 1) { // Middle button
      e.preventDefault();
      e.stopImmediatePropagation();
      
      // INFINITE WARNINGS - NO TERMINATION
      showSecurityWarning("Middle mouse button is not allowed during examination");
      return false;
    }
    if (e.button === 2) { // Right button
      e.preventDefault();
      e.stopImmediatePropagation();
      
      // INFINITE WARNINGS - NO TERMINATION
      showSecurityWarning("Right mouse button is not allowed during examination");
      return false;
    }
    if (e.button === 3 || e.button === 4) { // Navigation buttons
      e.preventDefault();
      e.stopImmediatePropagation();
      
      // INFINITE WARNINGS - NO TERMINATION
      showSecurityWarning("Mouse navigation buttons are not allowed during examination");
      return false;
    }
  }, true);

  // ---------------------------
  // OVERRIDE BROWSER FUNCTIONS
  // ---------------------------
  
  // Override window.open - INFINITE WARNINGS
  const originalWindowOpen = window.open;
  window.open = function() {
    if (examStarted && !examSubmitted && !isExamTerminated) {
      // INFINITE WARNINGS - NO TERMINATION
      showSecurityWarning("Opening new windows is not allowed during examination");
    }
    return null;
  };

  // Override fullscreen exit functions - PREVENT ALL EXITS
  ['exitFullscreen', 'webkitExitFullscreen', 'mozCancelFullScreen', 'msExitFullscreen'].forEach(method => {
    if (document[method]) {
      const original = document[method];
      document[method] = function() {
        if (examStarted && !examSubmitted && !isExamTerminated && !isShowingWarning) {
          // Block the exit and show warning
          if (violationCount >= maxViolations) {
            terminateExamImmediately(`Maximum security violations reached - Attempted to exit fullscreen using ${method}`);
          } else {
            showSecurityWarning("Exiting fullscreen is not allowed during exam");
          }
          return Promise.reject(new Error("Fullscreen exit blocked during exam"));
        }
        return original.call(this);
      };
    }
  });

  // ---------------------------
  // ADDITIONAL SECURITY OVERRIDES
  // ---------------------------
  
  // Block print
  window.addEventListener('beforeprint', (e) => {
    if (examStarted && !examSubmitted && !isExamTerminated) {
      e.preventDefault();
      e.stopImmediatePropagation();
      
      if (violationCount >= maxViolations) {
        terminateExamImmediately("Maximum security violations reached - Print attempt detected");
      } else {
        showSecurityWarning("Printing is not allowed during exam");
      }
      return false;
    }
  }, true);

  // Block drag operations
  document.addEventListener("dragstart", e => {
    if (examStarted && !isShowingWarning) {
      e.preventDefault();
      e.stopImmediatePropagation();
      logSecurityViolation("Drag operation blocked");
      return false;
    }
  }, true);

  // Block copy/cut outside input fields
  ['copy', 'cut'].forEach(eventType => {
    document.addEventListener(eventType, e => {
      if (examStarted && !e.target.matches('input, textarea') && !isShowingWarning) {
        e.preventDefault();
        e.stopImmediatePropagation();
        logSecurityViolation(`${eventType} operation blocked`);
        return false;
      }
    }, true);
  });

  // ---------------------------
  // Confirmation Modal Functions
  // ---------------------------
  function showConfirmationModal() {
    document.getElementById('confirmationModal').style.display = 'block';
  }

  function hideConfirmationModal() {
    document.getElementById('confirmationModal').style.display = 'none';
  }

  // Modal event listeners
  document.getElementById('confirmSubmit').addEventListener('click', () => {
    hideConfirmationModal();
    examSubmitted = true;
    exitFullScreen().finally(() => {
      document.getElementById("exam-form").submit();
    });
  });

  document.getElementById('cancelSubmit').addEventListener('click', () => {
    hideConfirmationModal();
  });

  // Close modal when clicking outside
  document.getElementById('confirmationModal').addEventListener('click', (e) => {
    if (e.target.id === 'confirmationModal') {
      hideConfirmationModal();
    }
  });

  // ---------------------------
  // Submit handlers
  // ---------------------------
  const finalSubmitBtn = document.getElementById("final-submit");
  if (finalSubmitBtn) {
    finalSubmitBtn.addEventListener("click", () => {
      showConfirmationModal();
    });
  }

  const examForm = document.getElementById("exam-form");
  if (examForm) {
    examForm.addEventListener("submit", (e) => {
      if (!examSubmitted) {
        e.preventDefault();
        showConfirmationModal();
        return false;
      }
    });
  }

  // Used by timer or external triggers
  window.endExam = function () {
    examSubmitted = true;
    exitFullScreen().finally(() => {
      alert("Time is up! Submitting your exam.");
      document.getElementById("exam-form")?.submit();
    });
  };

  // ---------------------------
  // Question navigation & state
  // ---------------------------
  let currentIndex = 0;
  const answeredQuestions = new Set();
  const flaggedQuestions = new Set();

  window.showQuestion = function (index) {
    document.querySelectorAll(".question-page").forEach(q => q.style.display = "none");
    const target = document.getElementById("question-" + index);
    if (target) target.style.display = "block";

    document.querySelectorAll(".question-btn").forEach((btn, i) => {
      btn.classList.toggle("current", i === index);
    });

    currentIndex = index;
  };

  window.nextQuestion = function (index) {
    if (index + 1 < (window.totalQuestions || 0)) window.showQuestion(index + 1);
  };

  window.prevQuestion = function (index) {
    if (index - 1 >= 0) window.showQuestion(index - 1);
  };

  window.flagQuestion = function (qid) {
    const btn = document.getElementById("nav-btn-" + qid);
    if (!btn) return;

    if (flaggedQuestions.has(qid)) {
      btn.classList.remove("flagged");
      flaggedQuestions.delete(qid);
      if (answeredQuestions.has(qid)) btn.classList.add("answered");
    } else {
      btn.classList.add("flagged");
      btn.classList.remove("answered");
      flaggedQuestions.add(qid);
      answeredQuestions.delete(qid);
    }
  };

  window.markAnswered = function (qid) {
    const btn = document.getElementById("nav-btn-" + qid);
    if (!btn) return;

    if (!flaggedQuestions.has(qid)) {
      btn.classList.add("answered");
      btn.classList.remove("flagged");
      answeredQuestions.add(qid);
    }
  };

  // ---------------------------
  // Timer
  // ---------------------------
  window.startTimer = function (duration, display) {
    let timer = duration;
    const intervalId = setInterval(() => {
      const h = String(Math.floor(timer / 3600)).padStart(2, '0');
      const m = String(Math.floor((timer % 3600) / 60)).padStart(2, '0');
      const s = String(timer % 60).padStart(2, '0');
      display.textContent = `${h}:${m}:${s}`;

      if (timer === 5 * 60) {
        display.style.color = 'red';
        display.style.animation = 'blink 1s infinite';
      }

      if (timer <= 0) {
        clearInterval(intervalId);
        examSubmitted = true;
        exitFullScreen().finally(() => {
          alert("Time is up! Submitting your exam.");
          document.getElementById("exam-form")?.submit();
        });
      }

      timer -= 1;
    }, 1000);
  };

  // ---------------------------
  // Init
  // ---------------------------
  (function init() {
    const display = document.getElementById("timer");
    const duration = {{ duration_seconds|default:0 }};

    if (display && duration > 0) {
      startTimer(duration, display);
    }

    window.totalQuestions = {{ questions|length|default:0 }};

    if (window.totalQuestions > 0) showQuestion(0);

    const style = document.createElement('style');
    style.textContent = `@keyframes blink { 50% { opacity: 0.5; } }`;
    document.head.appendChild(style);
  })();

  // ---------------------------
  // NUCLEAR BROWSER OVERRIDE SYSTEM
  // ---------------------------
  
  // Override ALL fullscreen exit methods at document level
  const fullscreenExitMethods = [
    'exitFullscreen',
    'webkitExitFullscreen', 
    'webkitCancelFullScreen',
    'mozCancelFullScreen',
    'msExitFullscreen'
  ];

  fullscreenExitMethods.forEach(method => {
    if (document[method]) {
      const original = document[method];
      document[method] = function() {
        if (examStarted && !examSubmitted && !isExamTerminated && !isShowingWarning) {
          // Block the exit completely
          logSecurityViolation(`Blocked fullscreen exit attempt via ${method}`);
          
          // Force re-entry immediately
          setTimeout(() => {
            if (!isInFullscreen()) {
              enterFullScreen();
            }
          }, 1);
          
          return Promise.reject(new Error("Fullscreen exit blocked during exam"));
        }
        return original.call(this);
      };
    }
  });

  console.log("üîí NUCLEAR FULLSCREEN LOCK ACTIVATED");
  console.log("üö® Monitoring every 10ms - Escape is IMPOSSIBLE");
  console.log("‚ö†Ô∏è INFINITE WARNINGS - No termination limit");
  console.log("üîê MOUSE LOCK - Modal traps all interactions");
  console.log("üö´ Tab switching = IMMEDIATE TERMINATION");
});

// Prevent back/forward navigation
window.addEventListener("pageshow", function (e) {
    const nav = performance.getEntriesByType && performance.getEntriesByType("navigation")[0];
    const viaBFCache = e.persisted || (nav && nav.type === "back_forward");
    if (viaBFCache) location.reload();
});

// Enhanced beforeunload warning
window.addEventListener("beforeunload", e => {
    if (!examSubmitted) {
        e.preventDefault();
        e.returnValue = "Are you sure you want to leave the exam? Your progress may be lost.";
        return "Are you sure you want to leave the exam? Your progress may be lost.";
    }
});
</script>

</body>
</html>